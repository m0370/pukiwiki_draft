# PukiWiki 下書き機能 v1.1.0 リリースノート

## バージョン情報
- **バージョン**: 1.1.0
- **リリース日**: 2025-11-22
- **対象**: PukiWiki 1.5.4
- **テスト環境**: PHP 8.4.14
- **評価**: 優良（本番環境投入可能）

## 主な変更点

### セキュリティ改善
- ✅ **CSRF脆弱性を完全に解決** - delete/publish/draft_save操作にCSRFトークン検証を実装
- ✅ **XSS対策の強化** - confirm()メッセージのJavaScriptエスケープを実装
- ✅ **権限チェック強化** - 下書き一覧表示時に編集権限チェックを追加

### 機能改善
- ✅ **編集衝突検知メカニズム実装** - 下書き公開時にMD5ダイジェスト/タイムスタンプで競合を検知
- ✅ **差分表示機能** - 競合時に現在ページと下書きの差分を表示
- ✅ **強制公開オプション** - ユーザーが意図的に上書き可能に

### コード品質向上
- ✅ **get_draft_with_meta()新設** - メタデータ（保存時刻、MD5ダイジェスト）管理機能を実装
- ✅ **デッドコード削除** - get_draft()をリファクタリングし、可読性を向上
- ✅ **ファイル操作エラーハンドリング改善** - fopen/flock/fputs失敗時の処理を強化

### 国際化対応
- ✅ **完全なローカライゼーション** - 日本語（ja.lng.php）・英語（en.lng.php）に対応
- ✅ **18-23個の言語変数追加** - UI全体を言語環境に応じて自動切り替え

## 修正した課題（v1.1.0）

| # | 項目 | 深刻度 | 状態 |
|---|------|--------|------|
| 1 | CSRF脆弱性 | 高 | ✅ 修正 |
| 2 | XSS脆弱性 | 低 | ✅ 修正 |
| 3 | ファイルオープンエラーハンドリング | 中 | ✅ 修正 |
| 4 | draft_write()エラーハンドリング | 中 | ✅ 修正 |
| 5 | ファイルロック非対称性 | 高 | ✅ 修正 |
| 6 | 国際化対応 | 低 | ✅ 修正 |
| 14 | 下書き一覧権限チェック | 中 | ✅ 修正 |
| 25 | draft_saveのCSRF | 高 | ✅ 修正 |
| 26 | 英語UI言語変数未定義 | 中 | ✅ 修正 |
| 27 | 下書き公開時の編集衝突 | 高 | ✅ 修正 |
| 28 | get_draft()互換性 | 中 | ✅ 修正 |

## 動作確認
- ✅ PHP 8.4.14で動作確認済み
- ✅ PHP 8.3互換性確認済み（PHP 9.0対応も視野）
- ✅ ローカル環境（macOS + Apache + PHP-FPM）で完全動作確認
- ✅ 日本語UI環境での全機能動作確認
- ✅ 英語UI環境での全機能動作確認

## インストール方法
1. `lib/draft.php`を更新
2. `plugin/draft.inc.php`を更新
3. `plugin/edit.inc.php`を更新
4. `lib/html.php`を更新
5. `lib/init.php`に`get_ticket()`と`check_ticket()`関数を追加
6. `ja.lng.php`と`en.lng.php`に言語変数を追加
7. ブラウザキャッシュをクリアして動作確認

## 既知の制限事項
- 自動保存機能は未実装（手動保存で十分なため低優先度）
- 下書きの定期自動削除機能は未実装（データ損失リスクのため不要と判断）

## 推奨される次のステップ
1. 本番環境へのデプロイ
2. ユーザーからのフィードバック収集
3. 将来的に自動保存機能を検討（要望があれば）

## その他
- GitHub: https://github.com/m0370/pukiwiki_draft
- ドキュメント: DRAFT_FEATURE.md、README_DRAFT.mdを参照
