# PukiWiki 下書き機能 TODO

**バージョン名**: Security and Quality Fixes  
**バージョン**: 1.1.0  
**作成日**: 2025-11-22  
**対象**: PukiWiki 1.5.4 + Draft機能 v1.1.0  
**分析環境**: PHP 8.4.14

## 変更履歴（サマリ）
- **1.2.0 (2025-11-22)**: 自動保存機能を実装。国際化対応（日本語・英語）、自動保存間隔60秒、言語変数の動的埋め込みを完了。FormData送信の問題と既存下書き上書き問題を発見し対応方針を策定。
- **1.1.0 (2025-11-22)**: CSRF/権限/XSSを含む主要なセキュリティ修正を完了し、ファイルI/Oとi18nを全面見直し。下書き公開時のダイジェスト検証やUI強化もこの版で実装済み。
- **1.0.0 (2025-11-22)**: 下書き機能の包括的な初回分析を完了し、問題の洗い出しと優先度付けを実施。

## 修正済み事項（要約）
- CSRF/XSS/権限に関する既知の脆弱性は `plugin/draft.inc.php`・`plugin/edit.inc.php`・`lib/html.php` で対策済み。
- `lib/draft.php` では `get_draft()` 周辺のデッドコード整理とファイルロック/エラーハンドリング改善を実施済み。
- 言語リソースは `ja.lng.php` / `en.lng.php` 双方に `_msg_draft_*` 変数を追加済みで、国際化ギャップは閉塞。
- **自動保存機能（v1.2.1）**: `skin/js/autosave.js` + `lib/html.php` で自動保存を実装。
  - 自動保存間隔: 30秒
  - UI: トースト通知（成功時）、ステータス表示
  - 対策済み: FormData送信問題、既存下書き上書き問題、HTML構造破壊問題
- ドキュメント（DRAFT_FEATURE.md 等）は安全な権限設定や運用上の注意点を追記済み。

## 新規検証事項（2025-11-23）

### v1.2.1 実装完了事項
- ✅ **自動保存メッセージの国際化**: `ja.lng.php` と `en.lng.php` に4つの言語変数を追加
- ✅ **html.php での言語変数埋め込み**: `lib/html.php` で `json_encode()` を使って JavaScript 変数 `AUTOSAVE_MESSAGES` を動的生成
- ✅ **autosave.js の国際化対応**: `skin/js/autosave.js` で `window.AUTOSAVE_MESSAGES` からメッセージを取得
- ✅ **自動保存間隔の調整**: 30秒に設定（ユーザー要望）
- ✅ **トースト通知**: 保存成功時に画面右上に通知を表示
- ✅ **HTML構造の修正**: scriptタグの配置を修正し、main.jsの読み込み問題を解決
- ✅ **aname問題の調査**: `&aname(...)`が表示される問題はPukiWikiコア（プラグイン未実装）の問題であり、自動保存機能とは無関係であることを確認

### 解決済みの問題
- **🔴 自動保存の処理ルート誤り**: FormDataを手動構築することで解決
- **🟡 既存下書き上書き**: `#draft_notice`の存在チェックで解決
- **🔴 HTML構造破壊**: scriptタグを`</div>`の後に移動することで解決

### 残存課題（自動保存機能外）
- **anameプラグイン未実装**: `&aname(...)`がそのまま表示される問題は、`plugin/aname.inc.php`を実装するか、Wikiソースを修正する必要がある（今回はスコープ外）

## 対応方針と次アクション

### 完了
自動保存機能の実装は完了しました。すべての既知の問題（自動保存に関連するもの）は解決されました。

### 次のステップ
- 実機での最終動作確認
- 必要に応じて`aname`プラグインの実装（別タスクとして）
