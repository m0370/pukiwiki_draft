# PukiWiki 下書き機能 v1.2.1 リリースノート

## バージョン情報
- **バージョン**: 1.2.1
- **リリース日**: 2025-11-23
- **対象**: PukiWiki 1.5.4
- **テスト環境**: PHP 8.4.14
- **評価**: 優良（本番環境投入可能）

## 主な変更点

### 新機能: 自動保存機能の実装 🎉
- ✅ **30秒ごとの自動保存** - 編集中の内容を自動的に下書きとして保存
- ✅ **トースト通知** - 保存成功時に画面右上に通知を表示（スライドインアニメーション付き）
- ✅ **ステータス表示** - 編集フォーム下に保存状態をリアルタイム表示
- ✅ **既存下書き保護** - 既存下書き通知が表示されている間は自動保存を停止し、上書きを防止

### 国際化対応の強化
- ✅ **自動保存メッセージの多言語化** - 日本語・英語の両方に対応
- ✅ **動的メッセージ読み込み** - PHP側から言語変数をJavaScriptに動的に渡す仕組みを実装

### 技術的改善
- ✅ **FormData送信の最適化** - 必要最小限のフィールドのみを送信し、処理ルートの誤りを防止
- ✅ **重複実行防止** - `isSaving`フラグにより保存中の再実行を防止
- ✅ **堅牢なエラーハンドリング** - ネットワークエラー、サーバーエラーの適切な処理
- ✅ **HTML構造の修正** - scriptタグの配置を最適化し、main.jsとの競合を解消

### バグ修正
- ✅ **aname問題の調査** - `&aname(...)`が表示される問題を調査（PukiWikiコアの問題であることを確認）
- ✅ **見出しアンカー表示問題の修正** - HTML構造の正常化により解決

## 実装した課題（v1.2.1）

| # | 項目 | 深刻度 | 状態 |
|---|------|--------|------|
| 1 | 自動保存機能の実装 | 高 | ✅ 実装 |
| 2 | FormData送信フィールドの最適化 | 中 | ✅ 修正 |
| 3 | 既存下書き無確認上書き防止 | 高 | ✅ 修正 |
| 4 | HTML構造破壊問題 | 高 | ✅ 修正 |
| 5 | 保存中の重複実行防止 | 中 | ✅ 修正 |
| 6 | 国際化対応（自動保存） | 低 | ✅ 実装 |
| 7 | トースト通知の実装 | 低 | ✅ 実装 |
| 8 | 保存間隔の調整（60秒→30秒） | 低 | ✅ 調整 |

## 技術仕様

### 自動保存機能
- **保存間隔**: 30秒
- **通信方式**: Fetch API（非同期）
- **セキュリティ**: CSRF保護（ticketフィールド）、権限チェック（check_editable）
- **対象ブラウザ**: モダンブラウザ（Chrome, Firefox, Safari, Edge）
- **依存関係**: Vanilla JavaScript（jQueryなし）

### 新規ファイル
- `skin/js/autosave.js` - 自動保存のメインロジック
- `AUTOSAVE_IMPLEMENTATION.md` - 実装の詳細仕様

### 変更ファイル
- `lib/html.php` - 国際化メッセージの動的埋め込み、autosave.jsの読み込み
- `ja.lng.php` - 自動保存関連の言語変数を4つ追加
- `en.lng.php` - 同上（英語版）
- `TODO.md` - v1.2.1の実装履歴を記録

## 動作確認
- ✅ PHP 8.4.14で動作確認済み
- ✅ PHP 8.3互換性確認済み
- ✅ ローカル環境（macOS + Apache + PHP-FPM）で完全動作確認
- ✅ 日本語UI環境での自動保存動作確認
- ✅ 英語UI環境での自動保存動作確認
- ✅ CSRF保護の動作確認
- ✅ 既存下書き保護の動作確認

## インストール方法

### 新規インストール
1. リリースファイルをダウンロード
2. `lib/draft.php`を配置
3. `lib/html.php`を更新
4. `plugin/draft.inc.php`を配置
5. `plugin/edit.inc.php`を更新
6. `skin/js/autosave.js`を配置（新規）
7. `ja.lng.php`と`en.lng.php`に言語変数を追加
8. ブラウザキャッシュをクリアして動作確認

### v1.1.0からのアップグレード
1. `lib/html.php`を更新
2. `skin/js/autosave.js`を新規配置
3. `ja.lng.php`に以下の4つの変数を追加:
   - `$_msg_draft_autosave_saving`
   - `$_msg_draft_autosave_saved`
   - `$_msg_draft_autosave_failed`
   - `$_msg_draft_autosave_error`
4. `en.lng.php`に同様の変数を追加（英語版）
5. ブラウザキャッシュをクリアして動作確認

## 既知の制限事項
- IE11は非サポート（Fetch APIとPromise.finally()を使用）
- セッションタイムアウト後は自動保存が失敗（PukiWiki全体の問題）
- aname問題はPukiWikiコアの問題であり、本バージョンではスコープ外

## ユーザー体験の向上

### 自動保存による安心感
編集中の内容が30秒ごとに自動保存されるため、以下のリスクから保護されます：
- ブラウザのクラッシュやフリーズ
- 誤ってタブを閉じる
- ネットワークの不安定さによる接続切断
- セッションタイムアウト

### 視覚的フィードバック
- **保存中**: 「保存中...」と表示
- **保存完了**: 「自動保存しました: 14:32」と時刻を表示
- **トースト通知**: 画面右上に成功通知（3秒後に自動消去）

### 既存下書きの保護
既存の下書きがある場合、通知が表示されている間は自動保存を停止し、ユーザーが下書きを読み込むまで待機します。これにより、意図しない上書きを防止します。

## 推奨される次のステップ
1. 本番環境へのデプロイ
2. ユーザーからのフィードバック収集
3. 自動保存間隔のカスタマイズ機能の検討（要望があれば）
4. オフライン対応の検討（Service Worker + IndexedDB）

## 関連ドキュメント
- **実装詳細**: `AUTOSAVE_IMPLEMENTATION.md`
- **技術仕様**: `DRAFT_FEATURE.md`
- **ユーザーマニュアル**: `README_DRAFT.md`
- **開発履歴**: `TODO.md`
- **技術記事**: `blog_autosave_feature.md`

## その他
- **GitHub**: https://github.com/m0370/pukiwiki_draft
- **リリースタグ**: v0.3
- **前バージョン**: v0.2 (v1.1.0)

---

**🎉 自動保存機能により、より安心してWikiを編集できるようになりました！**
