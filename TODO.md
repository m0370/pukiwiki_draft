# PukiWiki 下書き機能 TODO

**バージョン名**: Security and Quality Fixes
**バージョン**: 1.1.0
**作成日**: 2025-11-22
**対象**: PukiWiki 1.5.4 + Draft機能 v1.1.0
**分析環境**: PHP 8.4.14

## 変更履歴

### 1.1.0 "Security and Quality Fixes" (2025-11-22)
- **セキュリティ修正完了**: CSRF脆弱性を完全に解決（delete/publish/draft_save）
- **バグ修正**: ファイル操作のエラーハンドリングを改善（3件）
- **国際化対応**: プラグインおよびライブラリ層（lib/html.php）の言語変数対応完了
- **新たな問題**: get_draft()にデッドコードが発生
- **未解決**: XSSエスケープ（低リスク）、英語UI対応、編集衝突検知
- **評価追加**: 下書きクリーンアップを不要と判断、自動保存は実現可能だが優先度低と評価

### 1.0.0 "Initial Comprehensive Analysis" (2025-11-22)
- 初版リリース - 下書き機能の包括的な分析
- セキュリティ問題2件を特定（CSRF、XSS）
- バグ・安定性問題3件を特定
- コード品質改善点4件を特定
- PHP 8.3/9.0互換性検証3件
- UX改善提案6件
- テスト・ドキュメント改善3件
- セキュリティ検証3件
- 全24項目を優先度付けし、具体的な修正方法を記載

---

## 重大なバグ (セキュリティ)

### 1. **CSRF脆弱性** ✅ 修正済み（v1.1.0）
- **ファイル**: `plugin/draft.inc.php`
- **問題**: `delete`（削除）および `publish`（公開）アクションがGETリクエストで実行されていた
- **深刻度**: **高** - 認証されたユーザーの権限で任意の下書きを削除・公開可能
- **修正内容**:
  - ✅ 行119, 159: POST リクエストチェック (`$_SERVER['REQUEST_METHOD'] !== 'POST'`)
  - ✅ 行119, 159: CSRF トークン検証 (`check_ticket()`)
  - ✅ 行66: トークン生成 (`get_ticket()`)
  - ✅ 行76-91: フォームを POST 形式に変更
- **検証結果**: delete/publish はPukiWiki標準のCSRF対策パターンに準拠。**draft_saveにはCSRF未対策が別途残存 (#25)**。

### 2. **XSS脆弱性の可能性** ⚠️ 低リスク
- **ファイル**: `plugin/draft.inc.php:81, 90`, `lib/html.php:410`
- **問題**: JavaScriptのconfirm()内で言語変数を使用しているが、エスケープが不十分
- **深刻度**: **低** - 現在の日本語では問題ないが、他言語対応時にリスクあり
- **推奨修正** (3箇所):
  ```php
  // json_encode()でJS文字列化 + htmlsc()でHTML属性エスケープ
  onclick="return confirm(<?= htmlsc(json_encode($_msg_draft_publish_confirm)) ?>)"
  ```
  理由: シングルクォート、ダブルクォート、改行などを安全に処理

## 重大なバグ (機能・安定性)

### 3. **ファイルオープン時のエラーハンドリング不足** ✅ 修正済み（v1.1.0）
- **ファイル**: `lib/draft.php:44-64`
- **問題**: `@fopen`が失敗した場合、その後の処理で不正な引数が使用される可能性があった
- **深刻度**: **中** - ファイルシステムエラー時に警告やクラッシュの可能性
- **修正内容**:
  - ✅ 行44-45: ファイルオープン直後にエラーチェック (`if ($fp === FALSE) return FALSE`)
  - ✅ 行47-49, 61-63: `$lock`の値に関わらず、常に`$fp`が有効な状態で処理
  - ✅ 行52-59: `filesize()`と`fread()`のエラーチェック追加
- **検証結果**: ファイルシステムエラー時の安全性が向上。

### 4. **draft_write()のエラーハンドリング不足** ✅ 修正済み（v1.1.0）
- **ファイル**: `lib/draft.php:184-193`
- **問題**: `fputs`の戻り値チェックと`flock`の失敗チェックが不足していた
- **深刻度**: **中** - データ損失の可能性
- **修正内容**:
  - ✅ 行185: `flock()`の戻り値チェック (`if (flock($fp, LOCK_EX))`)
  - ✅ 行187-190: `fputs()`の戻り値チェックと書き込みバイト数検証
  - ✅ 行184-193: エラー時は`$success = FALSE`を返す
- **検証結果**: ディスク容量不足やI/Oエラー時のデータ損失リスクが大幅に軽減。

### 5. **ファイルロックの非対称性** ✅ 修正済み（v1.1.0）
- **ファイル**: `lib/draft.php:44-64`
- **問題**: `get_draft()`で`$lock = FALSE`の場合、`$fp`変数が未定義のままアクセスされる可能性があった
- **深刻度**: **高** - 未定義変数エラーの可能性
- **修正内容**:
  - ✅ 行44: ファイルオープンを最初に実行（`$lock`の値に関わらず）
  - ✅ 行47-49, 61-63: `$lock`フラグに基づいてロック制御のみ切り替え
  - ✅ 行64: `@fclose($fp)`は常に安全に実行可能
- **検証結果**: 未定義変数エラーのリスクは完全に解消。

### 5-1. **get_draft()のデッドコード問題** ⚠️ (#28と関連)
- **ファイル**: `lib/draft.php:73-131`
- **問題**: デッドコード残存 + `$join=false`時の`file()`互換性劣化
- **深刻度**: **中** - 可読性低下、末尾改行欠落の可能性
- **推奨対応**:
  1. `$join`で明確に分岐し、デッドコード(行94-130)を削除
  2. `$join=false`時は`file()`互換の配列(各行末に`\n`)を返す
  3. 不要なコメント(行79-122)を削除

## 改善点 (コード品質と保守性)

### 6. **ハードコードされた文字列 (国際化)** ⚠️ 部分的に修正（v1.1.0）
- **ファイル**:
  - ✅ `plugin/draft.inc.php`: 完全に言語変数化済み
  - ✅ `plugin/edit.inc.php`: 完全に言語変数化済み
  - ✅ `lib/html.php`: 完全に言語変数化済み
- **深刻度**: **低** - 機能には影響しないが、国際化対応が不完全
- **修正内容**:
  - ✅ `ja.lng.php`: 18個の言語変数を追加（461-478行）
  - ✅ プラグインファイルで言語変数を使用
- **未解決箇所** (`lib/html.php`):
  - 行401: `<span>下書きが保存されています ($draft_time)</span>`
  - 行405: `value="下書きから復帰"`
  - 行410: `confirm('すでに保存されている下書きがあります。下書きを上書き保存しますか？')`
  - 行451: `value="下書き保存"`
- **検証結果**: プラグイン層、ライブラリ層ともに完全に国際化対応済み。

### 7. **エラー抑制演算子の使用**
- **ファイル**: `lib/draft.php:45, 85`
- **問題**: `@fopen`と`@fclose`がエラー抑制のために使用されています
- **深刻度**: **低** - PukiWikiのレガシーコードでは一般的だが、デバッグが困難
- **評価**: PukiWiki本体のコーディングスタイルに準拠しているため、**修正不要**と判断
  - 参考: `lib/file.php`でも同様のパターンが使用されている
- **代替案** (将来的な改善): `is_readable()`による事前チェック

### 8. **型宣言の不足**
- **ファイル**: `lib/draft.php`, `plugin/draft.inc.php`, `plugin/edit.inc.php`
- **問題**: 関数の引数・戻り値に型宣言がありません
- **深刻度**: **低** - PHP 8.3/9.0では推奨されるが、後方互換性のため現状維持も可
- **修正方法** (PHP 7.4+):
  ```php
  function has_draft(string $page): bool
  function get_draft(string $page, bool $lock = true, bool $join = false): mixed
  function draft_write(string $page, string $postdata): bool
  ```
- **判断**: PukiWiki本体が型宣言を使用していない場合、**現状維持を推奨**

### 9. **get_draft()の戻り値の一貫性**
- **ファイル**: `lib/draft.php:38-90`
- **問題**:
  - `$join = TRUE`の場合: 文字列 or FALSE
  - `$join = FALSE`の場合: 配列 or FALSE
  - ファイルが存在しない場合: 空文字列 or 空配列
  - 混在した戻り値型で、呼び出し側で厳密な型チェックが必要
- **深刻度**: **低** - 既存のPukiWikiパターンに準拠
- **評価**: `get_source()`など既存関数と同様のパターンのため、**現状維持**

## PHP 8.3 / 9.0 互換性

### 10. **usortコールバックの戻り値**
- **ファイル**: `lib/draft.php:182-184`
- **問題**: `usort`に渡される無名関数が減算の結果を返していますが、型の曖昧性があります
- **深刻度**: **低** - 現在の実装では安全だが、明示的な方が良い
- **現在のコード**:
  ```php
  usort($pages, function($a, $b) {
      return get_draft_filetime($b) - get_draft_filetime($a);
  });
  ```
- **評価**: `get_draft_filetime()`は必ず整数を返す（失敗時は0）ため、**実質的に安全**
- **推奨改善** (将来的):
  ```php
  usort($pages, function($a, $b) {
      $time_a = get_draft_filetime($a);
      $time_b = get_draft_filetime($b);
      return ($time_b <=> $time_a); // PHP 7.0+ spaceship operator
  });
  ```

### 11. **filemtime()の戻り値処理**
- **ファイル**: `lib/draft.php:111`
- **問題**: `filemtime()`はファイルが存在しない場合やエラー時にFALSEを返す可能性
- **深刻度**: **低** - `has_draft()`で事前チェックしているため安全
- **現在のコード**:
  ```php
  return has_draft($page) ? filemtime(get_draft_filename($page)) - LOCALZONE : 0;
  ```
- **評価**: 事前に`has_draft()`でチェックしているため、**修正不要**

### 12. **preg_match戻り値の型**
- **ファイル**: `lib/draft.php:173`
- **問題**: PHP 8.0+では`preg_match`がエラー時にfalseを返す可能性があり、厳密な型チェックが必要
- **深刻度**: **極低** - 正規表現パターンが静的で安全
- **評価**: パターンが固定で安全なため、**修正不要**

## ロジックとUXの改善

### 13. **下書きの競合解決**
- **問題**: 複数のユーザーが同じページを編集した場合、ページ名に基づいて下書きがお互いに上書きされます
- **深刻度**: **中** - マルチユーザー環境でデータ損失の可能性
- **修正案**:
  1. **案A**: ファイル名にユーザーID/セッションIDを追加
     - 例: `draft/[page_encode].[user_id].txt`
     - メリット: 完全な分離
     - デメリット: 認証が無効な環境では機能しない
  2. **案B**: 下書きの所有者情報をメタデータに記録
     - 既存の`#draft_saved:`に`#draft_owner:`を追加
     - 他ユーザーの下書きがある場合に警告表示
  3. **案C**: 最終更新日時でチェック
     - 下書き保存時に既存の下書きのタイムスタンプと比較
     - 新しい下書きがある場合は警告
- **推奨**: まず**案C**を実装し、必要に応じて**案B**を追加

### 14. **下書き一覧での権限チェックの不足** ✅ 修正済み（v1.1.0）
- **ファイル**: `plugin/draft.inc.php:68`
- **問題**: 下書き一覧で編集権限を持たないページの下書きも表示される可能性があった
- **深刻度**: **中** - 情報漏洩の可能性
- **修正内容**:
  - ✅ 行68: `if (!is_editable($page)) continue;` で権限チェック実装
- **検証結果**: TODO.mdで提案した修正方法と完全一致。情報漏洩リスクは解決。

### 15. **下書きのクリーンアップ** ❌ 不要と判断
- **問題**: 下書きは公開または削除されるまで無期限に残ります
- **深刻度**: **低** - ディスク容量の浪費、管理の煩雑化
- **評価**: **実装不要**
  - 下書きはユーザーが明示的に保存した重要なデータ
  - 自動削除はデータ損失のリスクがあり、ユーザー体験を損なう
  - ディスク容量の問題は現実的には発生しにくい
- **代替案**: 必要であれば、管理者が手動で古い下書きを削除できる機能のみ検討

### 16. **自動保存機能** ⚠️ 実現可能だが優先度低
- **問題**: 現在は手動保存のみサポート
- **深刻度**: **低** - UX改善の余地あり
- **実現可能性**: ✅ **技術的には実現可能（難易度: 中）**
- **実装方法**:
  ```javascript
  // Vanilla JavaScript での実装例
  let autoSaveTimer;
  let lastContent = '';

  function autoSaveDraft() {
      const textarea = document.querySelector('textarea[name="msg"]');
      const currentContent = textarea.value;

      // 内容が変更されていれば保存
      if (currentContent !== lastContent && currentContent.length > 0) {
          const formData = new FormData();
          formData.append('cmd', 'edit');
          formData.append('page', document.querySelector('input[name="page"]').value);
          formData.append('msg', currentContent);
          formData.append('draft_save', '1');

          fetch(location.href, {
              method: 'POST',
              body: formData
          }).then(() => {
              // 控えめな通知（例: ステータスバーに表示）
              showAutoSaveNotice();
              lastContent = currentContent;
          });
      }
  }

  // 60秒ごとに自動保存
  autoSaveTimer = setInterval(autoSaveDraft, 60000);
  ```
- **課題**:
  - PukiWikiのJavaScript環境（jQuery有無）の確認が必要
  - エラーハンドリング（ネットワークエラー、サーバーエラー）
  - ユーザー通知の実装（控えめで邪魔にならない表示）
  - 複数タブで同時編集時の競合
- **評価**: 実装可能だが、手動保存でも十分機能するため**優先度は低い**
- **推奨**: 現時点では見送り、ユーザーからの要望があれば検討

### 17. **下書きの差分表示**
- **問題**: 現在のページと下書きの差分が確認できない
- **深刻度**: **低** - UX改善
- **将来の実装案**:
  1. 下書き復帰前に現在のページとの差分を表示
  2. 既存の`do_update_diff()`関数を活用

### 18. **複数バージョンの下書き保存**
- **問題**: 1ページにつき1つの下書きのみ保存可能
- **深刻度**: **低** - 高度な機能要求
- **将来の実装案**:
  1. タイムスタンプ付きで複数バージョンを保存
  2. 例: `draft/[page_encode].[timestamp].txt`
  3. 下書き一覧で同一ページの複数バージョンを表示

## テストとドキュメント

### 19. **単体テストの不足**
- **問題**: 下書き機能のテストコードが存在しない
- **深刻度**: **低** - リグレッション防止のため推奨
- **推奨事項**:
  1. PHPUnitまたはSimpleTestでテストケース作成
  2. 最低限のテストケース:
     - 下書きの保存・読み込み・削除
     - 権限チェック
     - エラーハンドリング

### 20. **エラーメッセージの改善**
- **ファイル**: `plugin/draft.inc.php:100, 143`, `plugin/edit.inc.php:338, 375`
- **問題**: エラーメッセージが汎用的で、原因の特定が困難
- **深刻度**: **低** - デバッグの効率性
- **改善例**:
  - 「下書きの削除に失敗しました」→「下書きの削除に失敗しました。ファイルのパーミッションを確認してください。」
  - 「下書きの保存に失敗しました」→詳細なエラー理由を追加

### 21. **lib/html.php の edit_form() 関数の引数追加**
- **ファイル**: `lib/html.php:334`
- **問題**: `$hide_draft_notice`パラメータが追加されたが、後方互換性への影響が不明
- **深刻度**: **低** - 既存プラグインとの互換性
- **評価**: デフォルト値が`FALSE`のため、**既存の呼び出しには影響なし**
- **推奨**: 問題なし

## セキュリティ検証項目

### 22. **encode/decode関数の安全性検証** ✓
- **ファイル**: `lib/func.php:505-511`
- **検証内容**: `encode()`が`bin2hex()`を使用しており、ディレクトリトラバーサル攻撃は不可能
- **結論**: **安全** - 全ての文字が16進数に変換されるため、`../`などの特殊文字は無害化される

### 23. **check_editable()の動作確認** ✓
- **ファイル**: `plugin/draft.inc.php:105, 136`
- **検証内容**: 削除・公開時に`check_editable()`で権限チェック実施
- **結論**: **適切** - Pukiwikiの標準的な権限チェック機構を使用

### 24. **ファイルパーミッションの文書化**
- **ファイル**: `DRAFT_FEATURE.md:133-134`
- **問題**: `chmod 777`が推奨されているが、セキュリティリスクが高い
- **深刻度**: **中** - サーバー環境によっては危険
- **推奨**:
  1. Webサーバーのユーザー/グループのみ書き込み可能に設定（例: 755 or 775）
  2. ドキュメントにセキュリティ注意事項を追記
  3. インストーラーで適切なパーミッションを自動設定

## Codexレビューでの追加指摘（2026）

### 25. **draft_saveのCSRF未対策** 🔴 新規
- **ファイル**: `plugin/edit.inc.php:328-362`, `lib/html.php:451`
- **問題**: 下書き保存がHTTPメソッド／CSRFトークンを検証せずに実行される
- **影響**: 認証済みユーザーの権限で意図しない下書き保存が可能
- **推奨修正**:
  1. `plugin_edit_draft_save()`の冒頭に追加:
     ```php
     if ($_SERVER['REQUEST_METHOD'] !== 'POST' || !check_ticket()) {
         return array('msg' => 'Error', 'body' => '<p>不正な操作です。</p>');
     }
     ```
  2. `lib/html.php:451`の下書き保存ボタンにhidden fieldでチケット追加:
     ```php
     <input type="hidden" name="ticket" value="<?= get_ticket() ?>" />
     ```

### 26. **英語UIで言語変数が未定義** ⚠️
- **ファイル**: `en.lng.php`
- **問題**: `_msg_draft_*`系列の言語変数が未定義
- **影響**: PHP 8.3で警告、ボタンラベルが空白
- **必要な変数リスト** (18個):
  ```php
  $_msg_draft_saved = 'Draft saved.';
  $_msg_draft_save_error = 'Failed to save draft.';
  $_msg_draft_save = 'Save Draft';
  $_msg_draft_not_found = 'Draft not found.';
  $_msg_draft_loaded = 'Draft loaded.';
  $_msg_draft_list = 'Draft List';
  $_msg_draft_edit = 'Edit';
  $_msg_draft_publish = 'Publish';
  $_msg_draft_delete = 'Delete';
  $_msg_draft_deleted = 'Draft deleted.';
  $_msg_draft_delete_error = 'Failed to delete draft.';
  $_msg_draft_published = 'Draft published';
  $_msg_draft_publish_confirm = 'Publish this draft?';
  $_msg_draft_delete_confirm = 'Delete this draft?';
  $_msg_draft_invalid_action = 'Invalid action.';
  $_msg_draft_exists = 'Draft saved (%s)';
  $_msg_draft_restore = 'Restore from draft';
  $_msg_draft_overwrite_confirm = 'Overwrite existing draft?';
  $_msg_draft_save_button = 'Save Draft';
  ```

### 27. **下書き公開で編集衝突を無視** ⚠️
- **ファイル**: `plugin/draft.inc.php:153-199`
- **問題**: `plugin_draft_publish()`が`page_write()`を直接呼び出し、`plugin_edit_write()`のようなダイジェスト衝突検知がない
- **影響**: 下書き作成後に本体ページが更新されても、公開時に警告なしで上書きしデータを失う可能性
- **推奨修正**: 下書き保存時点の`#draft_saved`タイムスタンプを現在のページ最終更新と比較し、乖離があれば警告・差分表示・衝突解決フローを追加

### 28. **get_draft($join=false)の互換性劣化** ⚠️ (#5-1と統合対応)
- **ファイル**: `lib/draft.php:38-131`
- **問題**: `file()`互換の末尾改行が失われる + デッドコード残存
- **影響**: 差分検知や表示が変化する可能性
- **推奨修正**: #5-1と同時に対応

## 優先度まとめ（v1.1.0 更新）

### ✅ 完了した項目（v1.1.0）
1. ✅ **CSRF（delete/publish）** - POST + check_ticket()で保護
2. ✅ **下書き一覧での権限チェック** - is_editable()で解決
3. ✅ **ファイルロックの非対称性** - 構造改善により解決
4. ✅ **draft_write()のエラーハンドリング** - flock, fputsチェック追加
5. ✅ **get_draft()のエラーハンドリング** - ファイル操作の安全性向上

### 🔴 新たに発見された問題（v1.1.0）
- #7 ⚠️ **get_draft()のデッドコード** - リファクタリング必要（中優先度）
- #8 ✅ **lib/html.phpの国際化** - 完了
- #9 ⚠️ **XSS confirm()エスケープ不足** - 低リスクだが対応推奨（低優先度）
- #25 🔴 **draft_saveのCSRF未対策** - 高優先度で要対応
- #26 ⚠️ **en.lng.phpで言語変数未定義** - 英語UIで警告
- #27 ⚠️ **下書き公開が編集衝突を無視** - データ消失リスク
- #28 ⚠️ **get_draft($join=false)の互換性劣化** - 改行欠落とデッドコード

### 📋 未着手の項目
10. ○ **下書きの競合解決** - マルチユーザー環境での改善（中優先度）
11. △ **複数バージョン保存** - 高度な機能（低優先度）
12. △ **下書きの差分表示** - UX改善（低優先度）

### ❌ 実装不要と判断された項目
13. ❌ **下書きのクリーンアップ** - データ損失リスクのため不要
14. ⚠️ **自動保存** - 実現可能だが優先度低、手動保存で十分

## 総評

### v1.1.0 での改善状況
- **セキュリティ**: ⚠️ **改善** - delete/publishのCSRFは解消したが、draft_saveのCSRFとconfirm未エスケープが残存
- **安定性**: ✅ **改善** - ファイル操作のエラーハンドリング強化
- **品質**: ⚠️ **部分的改善** - 国際化は英語UIが未定義、get_draftのデッドコードと互換性劣化が残存
- **総合評価**: **良好（セキュリティ課題残り）**

### 実装の品質
- **全体評価**: 良好 ✓
- **長所**:
  - PukiWikiのコーディング規約に準拠
  - delete/publishのCSRF対策と権限チェックは適切に実装
  - ファイル操作のエラーハンドリングが堅牢
  - 国際化対応が進展（プラグイン層）
  - 既存の関数パターンを踏襲

- **短所**:
  - draft_saveのCSRF未対策 (#25)
  - en.lng.phpに言語変数が未定義 (#26)
  - 下書き公開が編集衝突を無視 (#27)
  - get_draft()のデッドコードと互換性劣化 (#7, #28)
  - ✅ lib/html.phpの国際化完了 (#8)
  - confirm()のXSSエスケープが不十分（低リスク） (#9)

### PHP 8.3/9.0 互換性
- **評価**: 概ね互換性あり ✓
- **懸念点**:
  - 型宣言がないが、PukiWiki本体も同様のため問題なし
  - 厳密な型チェック（strict_types）を有効にしない限り、動作に支障なし

### 推奨される次のステップ（v1.1.0 以降）

1. **最優先のセキュリティ/安定性**:
   - draft_saveにPOST+`check_ticket()`を追加しCSRFを封じる (#25)
   - en.lng.phpへ下書き関連の言語変数を追加 (#26)
   - 下書き公開時の衝突検知/警告を追加 (#27)
   - confirm()のメッセージをJSエスケープする (#9)

2. **コード品質向上**:
   - get_draft()のロジック整理と互換性修復 (#7, #28)
   - ✅ lib/html.phpの国際化対応完了 (#8)

3. **機能改善** (中優先度):
   - 下書きの競合解決メカニズム実装（案Cから着手）
   - エラーメッセージの詳細化

4. **ドキュメント更新** (推奨):
   - ファイルパーミッションのセキュリティ注意事項追記
   - v1.1.0の変更内容をDRAFT_FEATURE.mdに反映

5. **機能拡張** (将来):
   - 自動保存機能
   - 下書きのクリーンアップ機能
   - 複数バージョン保存

## 備考

- 本TODOは PukiWiki 1.5.4 + Draft機能 v1.1.0 を対象としています
- PHP 8.4.14環境で検証済み（構文エラーなし）
- 既存のPukiWikiコーディング慣習を最大限尊重した評価を行っています
