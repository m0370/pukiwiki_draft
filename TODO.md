# PukiWiki 下書き機能 TODO

**バージョン名**: Initial Comprehensive Analysis
**バージョン**: 1.0.0
**作成日**: 2025-11-22
**対象**: PukiWiki 1.5.4 + Draft機能 v1.1.0
**分析環境**: PHP 8.4.14

## 変更履歴

### 1.0.0 "Initial Comprehensive Analysis" (2025-11-22)
- 初版リリース - 下書き機能の包括的な分析
- セキュリティ問題2件を特定（CSRF、XSS）
- バグ・安定性問題3件を特定
- コード品質改善点4件を特定
- PHP 8.3/9.0互換性検証3件
- UX改善提案6件
- テスト・ドキュメント改善3件
- セキュリティ検証3件
- 全24項目を優先度付けし、具体的な修正方法を記載

---

## 重大なバグ (セキュリティ)

### 1. **CSRF脆弱性** ⚠️ 最優先
- **ファイル**: `plugin/draft.inc.php:69-70, 76-77`
- **問題**: `delete`（削除）および `publish`（公開）アクションがGETリクエストで実行されています。これにより、攻撃者がログインユーザー（編集権限を持つユーザー）を誘導して、悪意のあるリンクをクリックさせることで、意図しない下書きの削除や公開を行わせることが可能です。
- **深刻度**: **高** - 認証されたユーザーの権限で任意の下書きを削除・公開可能
- **修正方法**:
  1. これらのアクションをPOSTリクエストに変更
  2. Pukiwikiの既存のチケット機構（`get_ticket()`, `check_ticket()`）を使用
  3. フォームベースのボタンに変更し、JavaScriptのconfirmは補助的に使用
- **参考実装**: `plugin/edit.inc.php`のwrite処理、`plugin/freeze.inc.php`など

### 2. **XSS脆弱性の可能性**
- **ファイル**: `plugin/draft.inc.php:76-77`, `lib/html.php:410`
- **問題**: JavaScriptのconfirm()内でページ名を使用していますが、適切にエスケープされているか不明確
- **深刻度**: **中** - ページ名に悪意のあるスクリプトが含まれる可能性は低いが検証必要
- **修正方法**:
  1. confirm()メッセージ内でページ名を使用する場合、JavaScriptエスケープを実施
  2. またはページ名を含めず汎用的なメッセージに変更
- **検証必要**: PukiwikiのページName制限とサニタイゼーション機構を確認

## 重大なバグ (機能・安定性)

### 3. **ファイルオープン時のエラーハンドリング不足**
- **ファイル**: `lib/draft.php:45-69`
- **問題**: `@fopen`が失敗した場合（FALSE返却）、その後の`filesize($file)`と`fread($fp, $size)`が不正な引数で実行される可能性があります
- **深刻度**: **中** - ファイルシステムエラー時に警告やクラッシュの可能性
- **修正方法**:
  ```php
  if ($lock) {
      $fp = @fopen($file, 'r');
      if ($fp === FALSE) return FALSE;
      flock($fp, LOCK_SH);
  } else {
      // Non-lock path should also handle errors
  }
  ```
  現在の実装では`$lock = TRUE`の場合のみエラーチェックしていますが、`$lock = FALSE`の場合の処理が不明確です

### 4. **draft_write()のエラーハンドリング不足**
- **ファイル**: `lib/draft.php:133-142`
- **問題**:
  1. `fopen`の失敗チェックはあるが、`fputs`の戻り値（書き込みバイト数またはFALSE）をチェックしていない
  2. `flock`の失敗可能性も考慮されていない
  3. ディスク容量不足やI/Oエラー時に不完全なデータが保存される可能性
- **深刻度**: **中** - データ損失の可能性
- **修正方法**:
  ```php
  $written = fputs($fp, $content);
  if ($written === FALSE || $written < strlen($content)) {
      flock($fp, LOCK_UN);
      fclose($fp);
      return FALSE;
  }
  ```

### 5. **ファイルロックの非対称性**
- **ファイル**: `lib/draft.php:43-87`
- **問題**: `get_draft()`で`$lock = FALSE`の場合、ファイルをロックせずに読み込みますが、`$fp`変数が未定義のまま後続処理（83-85行）でアクセスしようとする可能性
- **深刻度**: **高** - 未定義変数エラーの可能性
- **修正方法**: `$lock = FALSE`の場合の処理フローを明確化し、`$fp`を使用しないようにする

## 改善点 (コード品質と保守性)

### 6. **ハードコードされた文字列 (国際化)**
- **ファイル**:
  - `plugin/draft.inc.php`: 61, 84, 100, 111, 131, 143, 154, 158行
  - `plugin/edit.inc.php`: 337, 348, 353, 390行
  - `lib/html.php`: 401, 410行
- **問題**: 「下書きはありません」「下書きを保存しました」などのメッセージが日本語でハードコードされています
- **深刻度**: **低** - 機能には影響しないが、国際化対応が不可能
- **修正方法**:
  1. 言語ファイル `ja.lng.php` に以下を追加:
     ```php
     $_msg_draft_no_drafts = '下書きはありません。';
     $_msg_draft_saved = '下書きを保存しました。';
     $_msg_draft_loaded = '下書きを読み込みました。';
     // ...など
     ```
  2. 各ファイルで変数を使用

### 7. **エラー抑制演算子の使用**
- **ファイル**: `lib/draft.php:45, 85`
- **問題**: `@fopen`と`@fclose`がエラー抑制のために使用されています
- **深刻度**: **低** - PukiWikiのレガシーコードでは一般的だが、デバッグが困難
- **評価**: PukiWiki本体のコーディングスタイルに準拠しているため、**修正不要**と判断
  - 参考: `lib/file.php`でも同様のパターンが使用されている
- **代替案** (将来的な改善): `is_readable()`による事前チェック

### 8. **型宣言の不足**
- **ファイル**: `lib/draft.php`, `plugin/draft.inc.php`, `plugin/edit.inc.php`
- **問題**: 関数の引数・戻り値に型宣言がありません
- **深刻度**: **低** - PHP 8.3/9.0では推奨されるが、後方互換性のため現状維持も可
- **修正方法** (PHP 7.4+):
  ```php
  function has_draft(string $page): bool
  function get_draft(string $page, bool $lock = true, bool $join = false): mixed
  function draft_write(string $page, string $postdata): bool
  ```
- **判断**: PukiWiki本体が型宣言を使用していない場合、**現状維持を推奨**

### 9. **get_draft()の戻り値の一貫性**
- **ファイル**: `lib/draft.php:38-90`
- **問題**:
  - `$join = TRUE`の場合: 文字列 or FALSE
  - `$join = FALSE`の場合: 配列 or FALSE
  - ファイルが存在しない場合: 空文字列 or 空配列
  - 混在した戻り値型で、呼び出し側で厳密な型チェックが必要
- **深刻度**: **低** - 既存のPukiWikiパターンに準拠
- **評価**: `get_source()`など既存関数と同様のパターンのため、**現状維持**

## PHP 8.3 / 9.0 互換性

### 10. **usortコールバックの戻り値**
- **ファイル**: `lib/draft.php:182-184`
- **問題**: `usort`に渡される無名関数が減算の結果を返していますが、型の曖昧性があります
- **深刻度**: **低** - 現在の実装では安全だが、明示的な方が良い
- **現在のコード**:
  ```php
  usort($pages, function($a, $b) {
      return get_draft_filetime($b) - get_draft_filetime($a);
  });
  ```
- **評価**: `get_draft_filetime()`は必ず整数を返す（失敗時は0）ため、**実質的に安全**
- **推奨改善** (将来的):
  ```php
  usort($pages, function($a, $b) {
      $time_a = get_draft_filetime($a);
      $time_b = get_draft_filetime($b);
      return ($time_b <=> $time_a); // PHP 7.0+ spaceship operator
  });
  ```

### 11. **filemtime()の戻り値処理**
- **ファイル**: `lib/draft.php:111`
- **問題**: `filemtime()`はファイルが存在しない場合やエラー時にFALSEを返す可能性
- **深刻度**: **低** - `has_draft()`で事前チェックしているため安全
- **現在のコード**:
  ```php
  return has_draft($page) ? filemtime(get_draft_filename($page)) - LOCALZONE : 0;
  ```
- **評価**: 事前に`has_draft()`でチェックしているため、**修正不要**

### 12. **preg_match戻り値の型**
- **ファイル**: `lib/draft.php:173`
- **問題**: PHP 8.0+では`preg_match`がエラー時にfalseを返す可能性があり、厳密な型チェックが必要
- **深刻度**: **極低** - 正規表現パターンが静的で安全
- **評価**: パターンが固定で安全なため、**修正不要**

## ロジックとUXの改善

### 13. **下書きの競合解決**
- **問題**: 複数のユーザーが同じページを編集した場合、ページ名に基づいて下書きがお互いに上書きされます
- **深刻度**: **中** - マルチユーザー環境でデータ損失の可能性
- **修正案**:
  1. **案A**: ファイル名にユーザーID/セッションIDを追加
     - 例: `draft/[page_encode].[user_id].txt`
     - メリット: 完全な分離
     - デメリット: 認証が無効な環境では機能しない
  2. **案B**: 下書きの所有者情報をメタデータに記録
     - 既存の`#draft_saved:`に`#draft_owner:`を追加
     - 他ユーザーの下書きがある場合に警告表示
  3. **案C**: 最終更新日時でチェック
     - 下書き保存時に既存の下書きのタイムスタンプと比較
     - 新しい下書きがある場合は警告
- **推奨**: まず**案C**を実装し、必要に応じて**案B**を追加

### 14. **下書き一覧での権限チェックの不足**
- **ファイル**: `plugin/draft.inc.php:64-79`
- **問題**: 下書き一覧では全ての下書きを表示するが、ユーザーが編集権限を持たないページの下書きも表示される可能性
- **深刻度**: **中** - 情報漏洩の可能性
- **修正方法**:
  ```php
  foreach ($drafts as $page) {
      // 権限チェック
      if (!is_editable($page)) {
          continue; // 編集権限がない場合はスキップ
      }
      // 既存の処理
  }
  ```

### 15. **下書きのクリーンアップ**
- **問題**: 下書きは公開または削除されるまで無期限に残ります
- **深刻度**: **低** - ディスク容量の浪費、管理の煩雑化
- **将来の実装案**:
  1. 一定期間（例: 30日）経過した下書きを自動削除
  2. 管理画面で古い下書きの一括削除機能
  3. 設定ファイルで保持期間を設定可能に

### 16. **自動保存機能**
- **問題**: 現在は手動保存のみサポート
- **深刻度**: **低** - UX改善の余地あり
- **将来の実装案**:
  1. JavaScriptで一定間隔（例: 60秒）ごとに自動保存
  2. AJAXでバックグラウンド保存（ページリロード不要）
  3. LocalStorageとの併用でオフライン対応

### 17. **下書きの差分表示**
- **問題**: 現在のページと下書きの差分が確認できない
- **深刻度**: **低** - UX改善
- **将来の実装案**:
  1. 下書き復帰前に現在のページとの差分を表示
  2. 既存の`do_update_diff()`関数を活用

### 18. **複数バージョンの下書き保存**
- **問題**: 1ページにつき1つの下書きのみ保存可能
- **深刻度**: **低** - 高度な機能要求
- **将来の実装案**:
  1. タイムスタンプ付きで複数バージョンを保存
  2. 例: `draft/[page_encode].[timestamp].txt`
  3. 下書き一覧で同一ページの複数バージョンを表示

## テストとドキュメント

### 19. **単体テストの不足**
- **問題**: 下書き機能のテストコードが存在しない
- **深刻度**: **低** - リグレッション防止のため推奨
- **推奨事項**:
  1. PHPUnitまたはSimpleTestでテストケース作成
  2. 最低限のテストケース:
     - 下書きの保存・読み込み・削除
     - 権限チェック
     - エラーハンドリング

### 20. **エラーメッセージの改善**
- **ファイル**: `plugin/draft.inc.php:100, 143`, `plugin/edit.inc.php:338, 375`
- **問題**: エラーメッセージが汎用的で、原因の特定が困難
- **深刻度**: **低** - デバッグの効率性
- **改善例**:
  - 「下書きの削除に失敗しました」→「下書きの削除に失敗しました。ファイルのパーミッションを確認してください。」
  - 「下書きの保存に失敗しました」→詳細なエラー理由を追加

### 21. **lib/html.php の edit_form() 関数の引数追加**
- **ファイル**: `lib/html.php:334`
- **問題**: `$hide_draft_notice`パラメータが追加されたが、後方互換性への影響が不明
- **深刻度**: **低** - 既存プラグインとの互換性
- **評価**: デフォルト値が`FALSE`のため、**既存の呼び出しには影響なし**
- **推奨**: 問題なし

## セキュリティ検証項目

### 22. **encode/decode関数の安全性検証** ✓
- **ファイル**: `lib/func.php:505-511`
- **検証内容**: `encode()`が`bin2hex()`を使用しており、ディレクトリトラバーサル攻撃は不可能
- **結論**: **安全** - 全ての文字が16進数に変換されるため、`../`などの特殊文字は無害化される

### 23. **check_editable()の動作確認** ✓
- **ファイル**: `plugin/draft.inc.php:105, 136`
- **検証内容**: 削除・公開時に`check_editable()`で権限チェック実施
- **結論**: **適切** - Pukiwikiの標準的な権限チェック機構を使用

### 24. **ファイルパーミッションの文書化**
- **ファイル**: `DRAFT_FEATURE.md:133-134`
- **問題**: `chmod 777`が推奨されているが、セキュリティリスクが高い
- **深刻度**: **中** - サーバー環境によっては危険
- **推奨**:
  1. Webサーバーのユーザー/グループのみ書き込み可能に設定（例: 755 or 775）
  2. ドキュメントにセキュリティ注意事項を追記
  3. インストーラーで適切なパーミッションを自動設定

## 優先度まとめ

### 最優先 (セキュリティリスク)
1. ✅ **CSRF脆弱性** - 即座に修正が必要
2. ✅ **下書き一覧での権限チェック** - 情報漏洩の可能性

### 高優先度 (バグ・安定性)
3. ✅ **ファイルロックの非対称性** - 実行時エラーの可能性
4. ⚠️ **draft_write()のエラーハンドリング** - データ損失の可能性
5. ⚠️ **get_draft()のエラーハンドリング** - エラー時の挙動改善

### 中優先度 (品質改善)
6. ○ **下書きの競合解決** - マルチユーザー環境での改善
7. ○ **国際化対応** - 保守性向上
8. ○ **XSS検証** - 念のための確認

### 低優先度 (機能拡張)
9. △ **自動保存** - UX改善
10. △ **下書きのクリーンアップ** - 運用改善
11. △ **複数バージョン保存** - 高度な機能

## 総評

### 実装の品質
- **全体評価**: 良好 ✓
- **長所**:
  - PukiWikiのコーディング規約に概ね準拠
  - 既存の関数パターン（`get_source()`など）を踏襲
  - 権限チェックを適切に実施
  - ファイルロックを使用したデータ整合性の確保

- **短所**:
  - CSRF対策の欠如（重大）
  - エラーハンドリングの不足
  - 国際化未対応

### PHP 8.3/9.0 互換性
- **評価**: 概ね互換性あり ✓
- **懸念点**:
  - 型宣言がないが、PukiWiki本体も同様のため問題なし
  - 厳密な型チェック（strict_types）を有効にしない限り、動作に支障なし

### 推奨される次のステップ
1. **セキュリティ修正** (必須):
   - CSRF対策の実装
   - 権限チェックの強化

2. **安定性向上** (推奨):
   - エラーハンドリングの改善
   - ファイル操作の堅牢化

3. **品質向上** (任意):
   - 国際化対応
   - 下書き競合の解決

4. **機能拡張** (将来):
   - 自動保存
   - クリーンアップ機能

## 備考

- 本TODOは PukiWiki 1.5.4 + Draft機能 v1.1.0 を対象としています
- PHP 8.4.14環境で検証済み（構文エラーなし）
- 既存のPukiWikiコーディング慣習を最大限尊重した評価を行っています
