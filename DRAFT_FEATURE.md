# PukiWiki 下書き機能

## 概要
PukiWikiに下書き機能を追加しました。ページ編集中の内容を一時保存し、後で再開できます。

## 機能一覧

### 1. 下書き保存
- 編集画面に「下書き保存」ボタンを追加
- 編集中の内容を下書きとして保存
- 本文に影響せずに保存可能

### 2. 下書き復帰
- 下書きがある場合、編集画面に通知を表示
- 「下書きから復帰」ボタンで保存した下書きを読み込み
- 前回の編集作業を継続可能

### 3. 下書き管理 (`?cmd=draft`)
- 全ての下書きを一覧表示
- 各下書きの保存日時を表示
- 下書きの編集・公開・削除が可能

## 実装ファイル

### 新規作成
- `draft/` - 下書きデータディレクトリ
- `lib/draft.php` - 下書き操作関数
  - `has_draft()` - 下書き存在確認
  - `get_draft()` - 下書き取得
  - `draft_write()` - 下書き保存
  - `draft_delete()` - 下書き削除
  - `get_draft_list()` - 下書き一覧取得
  - `get_draft_filename()` - 下書きファイル名取得
  - `get_draft_filetime()` - 下書き更新日時取得

- `plugin/draft.inc.php` - 下書き管理プラグイン
  - `plugin_draft_action()` - メイン処理
  - `plugin_draft_list()` - 一覧表示
  - `plugin_draft_delete()` - 削除処理
  - `plugin_draft_publish()` - 公開処理

### 変更ファイル
- `pukiwiki.ini.php` - DRAFT_DIR定義追加
- `lib/init.php` - DRAFT_DIRチェック追加
- `lib/html.php` - 編集フォームに下書きUI追加
- `plugin/edit.inc.php` - 下書き保存・読み込み処理追加
  - `plugin_edit_draft_save()` - 下書き保存処理
  - `plugin_edit_load_draft()` - 下書き読み込み処理

## 使用方法

### 下書きとして保存
1. ページ編集画面を開く
2. 内容を編集
3. 「下書き保存」ボタンをクリック
4. 編集画面に戻り、下書き保存完了の通知が表示される

### 下書きから復帰
1. 下書きがあるページの編集画面を開く
2. 上部に「下書きが保存されています」という通知が表示される
3. 「下書きから復帰」ボタンをクリック
4. 下書きの内容がテキストエリアに読み込まれる

### 下書き一覧を見る
1. `?cmd=draft` にアクセス
2. 全ての下書きが一覧表示される
3. 各下書きに対して以下の操作が可能:
   - 編集: 編集画面を開く
   - 公開: 下書きを本文として公開
   - 削除: 下書きを削除

### 下書きを公開
1. 下書き一覧から「公開」をクリック
2. 確認ダイアログで「OK」をクリック
3. 下書きが本文として公開され、下書きは削除される

## 技術仕様

### データ保存形式
下書きは `draft/` ディレクトリに保存されます:
```
draft/[ページ名の16進数エンコード].txt
```

各下書きファイルの形式:
```
#draft_saved:[ISO8601形式のタイムスタンプ]
[下書き本文]
```

### 権限管理
- 下書きの保存・読み込み・削除には、対象ページの編集権限が必要
- ページ編集権限のチェックと同じ仕組みを使用

### ファイル操作
- ファイルロック機能を使用して同時書き込みを防止
- 既存のPukiWikiファイル操作パターンに準拠

## テスト結果

### PHP構文チェック
✓ lib/draft.php - 構文エラーなし
✓ plugin/draft.inc.php - 構文エラーなし
✓ plugin/edit.inc.php - 構文エラーなし
✓ lib/html.php - 構文エラーなし

### 機能テスト
✓ has_draft() - 下書き存在確認
✓ draft_write() - 下書き保存
✓ get_draft() - 下書き取得
✓ get_draft_filename() - ファイル名取得
✓ get_draft_filetime() - 更新日時取得
✓ get_draft_list() - 一覧取得
✓ draft_delete() - 下書き削除

### プラグインロード
✓ plugin_draft_action() - メイン処理関数
✓ plugin_draft_list() - 一覧表示関数
✓ plugin_draft_delete() - 削除処理関数
✓ plugin_draft_publish() - 公開処理関数
✓ plugin_edit_draft_save() - 編集画面での下書き保存
✓ plugin_edit_load_draft() - 編集画面での下書き読み込み

### UI統合
✓ 編集フォームに下書きボタン追加
✓ 下書き存在時の通知表示
✓ 下書き復帰ボタン表示
✓ 設定ファイルにDRAFT_DIR定義
✓ 初期化時のディレクトリチェック

## 注意事項

1. **draftディレクトリのパーミッション**
   - `draft/` ディレクトリは書き込み可能(777)に設定する必要があります

2. **既存機能との互換性**
   - 既存のページ編集機能には影響しません
   - 下書き機能を使用しない場合、従来通りの動作です

3. **データの永続性**
   - 下書きは手動で削除するか、公開するまで保持されます
   - 自動削除機能は現在実装されていません

## 今後の拡張可能性

- 複数の下書きバージョン管理
- 下書きの自動保存
- 下書きの有効期限設定
- 下書きの検索機能
- 下書きのエクスポート/インポート

## ライセンス
GPL v2 or later (PukiWikiと同じライセンス)
